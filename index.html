<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OSRS Crafting Profit Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    h1, h2, h3 {
      color: #ffffff;
    }
    .profit {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #2b2b2b;
    }
    .positive {
      color: #00ff00;
    }
    .negative {
      color: #ff5555;
    }
    textarea {
      width: 100%;
      font-family: monospace;
      margin-top: 10px;
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 16px;
      background-color: #444;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #666;
    }
    input[type="text"], input[type="number"] {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 5px;
    }
    #skills-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 800px;
    }
    #skills-grid div {
      display: flex;
      flex-direction: column;
    }
    label {
      font-size: 14px;
      margin-bottom: 4px;
    }
    #skills-modal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #2b2b2b;
      color: #f0f0f0;
      border: 1px solid #555;
      padding: 20px;
      border-radius: 10px;
      z-index: 999;
      max-height: 80vh;
      overflow-y: auto;
      width: 90%;
      max-width: 850px;
    }
  </style>
</head>
<body>
  <h1>OSRS Crafting Profit Calculator</h1>
  <button onclick="refreshData()">Refresh Prices</button>
  <button onclick="toggleSkills()">Skills</button>
  <div id="results"></div>

  <h2>Custom Recipe</h2>
  <textarea id="custom-recipe" rows="5" placeholder="Example:\n1 Runite ore\n8 Coal\n= 1 Runite bar"></textarea><br>
  <button onclick="addCustomRecipe()">Add Custom Recipe</button>

  <div id="skills-modal">
    <h2>Enter Skill Levels</h2>
    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
      <input
        type="text"
        id="rsn"
        placeholder="Enter your character name"
        autocomplete="off"
        onkeydown="if(event.key==='Enter') fetchHiscores()"
        style="flex: 1;"
      />
      <button onclick="fetchHiscores()">Submit</button>
    </div>
    <div id="skills-grid"></div>
    <button onclick="toggleSkills()">Close</button>
  </div>

  <script>
    const baseCacheUrl = 'https://raw.githubusercontent.com/KeelanRobertson/osrs/main/data/';
    const mappingUrl = baseCacheUrl + 'mapping.json';
    const cacheUrls = ['latest.json', '5m.json', '10m.json', '30m.json', '1h.json'].map(name => baseCacheUrl + name);

    let itemsById = {};
    let itemsByName = {};
    let recipes = [];

    async function loadRecipes() {
      const res = await fetch('https://raw.githubusercontent.com/KeelanRobertson/osrs/main/data/recipes.json');
      recipes = await res.json();
    }

    async function fetchData() {
      const mapping = await fetch(mappingUrl).then(res => res.json());
      const priceData = await Promise.all(cacheUrls.map(url => fetch(url).then(res => res.json())));

      itemsById = {};
      itemsByName = {};

      mapping.forEach(item => {
        const id = item.id;
        const allPrices = priceData.map(d => d.data[id]).filter(Boolean);
        const highPrices = allPrices.map(d => d.avgHighPrice || d.high).filter(Boolean);
        const lowPrices = allPrices.map(d => d.avgLowPrice || d.low).filter(Boolean);
        const latest = priceData[0].data[id];

        itemsById[id] = {
          ...item,
          maxHigh: Math.max(...highPrices, 0),
          minLow: Math.min(...lowPrices, Infinity),
          currentHigh: latest?.high || 0,
          currentLow: latest?.low || 0
        };
        itemsByName[item.name.toLowerCase()] = itemsById[id];
      });
    }

    function calculateProfit(recipe) {
      const outputItem = itemsByName[recipe.output.item.toLowerCase()];
      const outputPrice = outputItem?.maxHigh * recipe.output.quantity || 0;

      const inputDetails = recipe.inputs.map(input => {
        const inputItem = itemsByName[input.item.toLowerCase()];
        const price = inputItem?.minLow || 0;
        const current = inputItem?.currentLow || 0;
        return {
          ...input,
          price,
          current,
          total: price * input.quantity
        };
      });

      const inputCost = inputDetails.reduce((sum, i) => sum + i.total, 0);
      const profit = outputPrice - inputCost;

      return {
        recipeName: recipe.name,
        outputItem: recipe.output.item,
        outputQuantity: recipe.output.quantity,
        outputPrice: outputItem?.maxHigh || 0,
        currentOutputPrice: outputItem?.currentHigh || 0,
        inputDetails,
        inputCost,
        profit
      };
    }

    function displayResults() {
      const container = document.getElementById("results");
      container.innerHTML = "";

      recipes.forEach(recipe => {
        const result = calculateProfit(recipe);
        const div = document.createElement("div");
        div.className = "profit";
        div.innerHTML = `
          <h3>${recipe.name}</h3>
          <p><strong>Current Profit:</strong> <span class="${result.profit >= 0 ? 'positive' : 'negative'}">${result.profit.toLocaleString()} gp</span></p>
          <p><strong>Sell Price of ${result.outputItem}:</strong> ${result.outputPrice.toLocaleString()} gp <em>(Current: ${result.currentOutputPrice.toLocaleString()} gp)</em></p>
          <p><strong>Input Costs:</strong></p>
          <ul>
            ${result.inputDetails.map(i =>
              `<li>${i.quantity} x ${i.item} @ ${i.price.toLocaleString()} gp <em>(Current: ${i.current.toLocaleString()} gp)</em> = ${i.total.toLocaleString()} gp</li>`
            ).join('')}
          </ul>
        `;
        container.appendChild(div);
      });
    }

    function parseCustomRecipe() {
      const lines = document.getElementById("custom-recipe").value.trim().split("\n");
      const inputs = [];
      let output = null;
      for (const line of lines) {
        if (line.includes("=")) {
          const [_, right] = line.split("=");
          const [qty, ...name] = right.trim().split(" ");
          output = { item: name.join(" "), quantity: parseInt(qty) };
        } else {
          const [qty, ...name] = line.trim().split(" ");
          inputs.push({ item: name.join(" "), quantity: parseInt(qty) });
        }
      }
      return { name: "Custom Recipe", inputs, output };
    }

    function addCustomRecipe() {
      const custom = parseCustomRecipe();
      recipes.push(custom);
      displayResults();
    }

    const skillNames = [
      "Attack", "Hitpoints", "Mining", "Strength", "Agility", "Smithing", "Defence", "Herblore",
      "Fishing", "Ranged", "Thieving", "Cooking", "Prayer", "Crafting", "Firemaking", "Magic",
      "Fletching", "Woodcutting", "Runecraft", "Slayer", "Farming", "Construction", "Hunter"
    ];

    function toggleSkills() {
      const modal = document.getElementById("skills-modal");
      modal.style.display = modal.style.display === "none" ? "block" : "none";
    }

    function createSkillInputs() {
      const container = document.getElementById("skills-grid");
      container.innerHTML = "";
      let total = 0;

      skillNames.forEach(skill => {
        const input = document.createElement("input");
        input.type = "number";
        input.min = 1;
        input.max = 99;
        input.value = 99;
        input.style.width = "100%";
        input.dataset.skill = skill;
        input.addEventListener("input", updateTotalLevel);
        const label = document.createElement("label");
        label.textContent = skill;
        const wrapper = document.createElement("div");
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        container.appendChild(wrapper);
        total += 99;
      });

      // Add total level box in last grid cell
      const totalLabel = document.createElement("label");
      totalLabel.textContent = "Total Level";
      const totalBox = document.createElement("div");
      totalBox.id = "total-level";
      totalBox.style.padding = "6px";
      totalBox.style.border = "1px solid #555";
      totalBox.style.background = "#333";
      totalBox.style.textAlign = "center";
      totalBox.style.color = "#fff";
      totalBox.style.fontWeight = "bold";
      totalBox.textContent = total;
      const totalWrapper = document.createElement("div");
      totalWrapper.appendChild(totalLabel);
      totalWrapper.appendChild(totalBox);
      container.appendChild(totalWrapper);
    }

    function updateTotalLevel() {
      const inputs = document.querySelectorAll("#skills-grid input");
      let total = 0;
      inputs.forEach(input => {
        let val = Math.min(parseInt(input.value) || 1, 99);
        input.value = val;
        total += val;
      });
      document.getElementById("total-level").textContent = total;
    }

    async function fetchHiscores() {
      const rsn = document.getElementById("rsn").value.trim();
      if (!rsn) return;
      try {
        const res = await fetch(`https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=${encodeURIComponent(rsn)}`);
        if (!res.ok) throw new Error("Player not found");
        const text = await res.text();
        const lines = text.trim().split("\n");
        // lines 1-23 correspond to skills in order: Overall, Attack, Defence, Strength, Hitpoints, Ranged, Prayer, Magic, Cooking, Woodcutting, Fletching, Fishing, Firemaking, Crafting, Smithing, Mining, Herblore, Agility, Thieving, Slayer, Farming, Runecrafting, Hunter, Construction
        // We map to our skillNames (23 total), ignoring overall (line 0)
        // Our skillNames order: Attack(0), Hitpoints(1), Mining(2), Strength(3), Agility(4), Smithing(5), Defence(6), Herblore(7), Fishing(8), Ranged(9), Thieving(10), Cooking(11), Prayer(12), Crafting(13), Firemaking(14), Magic(15), Fletching(16), Woodcutting(17), Runecraft(18), Slayer(19), Farming(20), Construction(21), Hunter(22)
        // Hiscore line indices: Attack(1), Defence(2), Strength(3), Hitpoints(4), Ranged(5), Prayer(6), Magic(7), Cooking(8), Woodcutting(9), Fletching(10), Fishing(11), Firemaking(12), Crafting(13), Smithing(14), Mining(15), Herblore(16), Agility(17), Thieving(18), Slayer(19), Farming(20), Runecrafting(21), Hunter(22), Construction(23)
        // We'll build a map from hiscore line index to skillNames index:
        const hiscoreIndices = {
          1: 0,  // Attack -> Attack
          4: 1,  // Hitpoints -> Hitpoints
          15: 2, // Mining -> Mining
          3: 3,  // Strength -> Strength
          17: 4, // Agility -> Agility
          14: 5, // Smithing -> Smithing
          2: 6,  // Defence -> Defence
          16: 7, // Herblore -> Herblore
          11: 8, // Fishing -> Fishing
          5: 9,  // Ranged -> Ranged
          18: 10, // Thieving -> Thieving
          8: 11,  // Cooking -> Cooking
          6: 12,  // Prayer -> Prayer
          13: 13, // Crafting -> Crafting
          12: 14, // Firemaking -> Firemaking
          7: 15,  // Magic -> Magic
          10: 16, // Fletching -> Fletching
          9: 17,  // Woodcutting -> Woodcutting
          21: 18, // Runecrafting -> Runecraft
          19: 19, // Slayer -> Slayer
          20: 20, // Farming -> Farming
          23: 21, // Construction -> Construction
          22: 22  // Hunter -> Hunter
        };
        const levels = new Array(skillNames.length).fill(1);

        for (let i = 1; i <= 23; i++) {
          const parts = lines[i].split(",");
          const level = Math.min(parseInt(parts[1]) || 1, 99);
          const idx = hiscoreIndices[i];
          if (idx !== undefined) {
            levels[idx] = level;
          }
        }

        const inputs = document.querySelectorAll("#skills-grid input");
        inputs.forEach((input, idx) => {
          input.value = levels[idx];
        });
        updateTotalLevel();
      } catch (e) {
        alert("Failed to fetch hiscores. Make sure the username is valid.");
      }
    }

    async function refreshData() {
      await Promise.all([fetchData(), loadRecipes()]);
      displayResults();
    }

    refreshData();
    createSkillInputs();
  </script>
</body>
</html>
